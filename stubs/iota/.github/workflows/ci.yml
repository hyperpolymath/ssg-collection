# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# CI Workflow — iota-ssg

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e0a7d90f9eaae48e5a29528a # v2.0.2
        with:
          deno-version: v1.x

      - name: Check adapter syntax
        run: |
          echo "Checking adapter syntax..."
          for f in adapters/*.js; do
            echo "Checking $f..."
            deno check "$f" || echo "Note: $f may need type annotations"
          done

      - name: Lint with deno
        run: |
          deno lint adapters/*.js || echo "Lint warnings found"

  validate-adapters:
    name: Validate Adapters
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e0a7d90f9eaae48e5a29528a # v2.0.2
        with:
          deno-version: v1.x

      - name: Validate adapter interfaces
        run: |
          echo "Validating adapter interfaces..."
          FAILED=0
          for f in adapters/*.js; do
            name=$(basename "$f" .js)
            [ "$name" = "README" ] && continue
            echo -n "Validating $name... "
            if deno eval "
              import * as a from './$f';
              const required = ['name', 'language', 'description', 'connect', 'disconnect', 'isConnected', 'tools'];
              const missing = required.filter(r => !(r in a));
              if (missing.length) {
                console.error('Missing:', missing.join(', '));
                Deno.exit(1);
              }
              console.log('OK');
            " 2>/dev/null; then
              echo ""
            else
              echo "FAILED"
              FAILED=1
            fi
          done
          exit $FAILED

      - name: Count adapters
        run: |
          count=$(ls -1 adapters/*.js | grep -v README | wc -l)
          echo "Total adapters: $count"
          if [ "$count" -lt 28 ]; then
            echo "Warning: Expected 28 adapters, found $count"
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint, validate-adapters]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e0a7d90f9eaae48e5a29528a # v2.0.2
        with:
          deno-version: v1.x

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            deno test tests/ --allow-read --allow-run
          else
            echo "No tests directory yet (planned for v0.4)"
          fi

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check required docs exist
        run: |
          required="README.adoc SECURITY.md CONTRIBUTING.md CODE_OF_CONDUCT.md"
          for doc in $required; do
            if [ ! -f "$doc" ]; then
              echo "Missing: $doc"
              exit 1
            fi
            if [ ! -s "$doc" ]; then
              echo "Empty: $doc"
              exit 1
            fi
            echo "✓ $doc exists"
          done

      - name: Check SCM files exist
        run: |
          scm_files="META.scm ECOSYSTEM.scm STATE.scm PLAYBOOK.scm AGENTIC.scm NEUROSYM.scm"
          for scm in $scm_files; do
            if [ ! -f "$scm" ]; then
              echo "Missing SCM file: $scm"
              exit 1
            fi
            echo "✓ $scm exists"
          done

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -rE "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" adapters/ --include="*.js" 2>/dev/null | grep -v "description"; then
            echo "⚠ Potential hardcoded secrets found"
            exit 1
          fi
          echo "✓ No hardcoded secrets detected"

      - name: Check .env not tracked
        run: |
          if [ -f ".env" ] && git ls-files --error-unmatch .env 2>/dev/null; then
            echo "⚠ .env file is tracked by git"
            exit 1
          fi
          echo "✓ No .env in git"

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, validate-adapters, test, docs-check, security-check]
    steps:
      - name: Summary
        run: |
          echo "✓ All CI checks passed!"
          echo ""
          echo "Completed checks:"
          echo "  - Lint & Format"
          echo "  - Adapter Validation"
          echo "  - Tests"
          echo "  - Documentation"
          echo "  - Security"
