# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
#
# Mustfile â€” rescribe-ssg
# Required checks and validations
#
# Usage: must <check>
# These are MANDATORY requirements that MUST pass

# ============================================================================
# Language Enforcement (CRITICAL)
# ============================================================================

# MUST: No Python files in src/
no-python:
    @echo "ğŸ” Checking for forbidden Python files..."
    @! find src/ -name "*.py" 2>/dev/null | grep -q . && echo "âœ… No Python files" || (echo "âŒ FORBIDDEN: Python files found in src/" && exit 1)

# MUST: No TypeScript files in src/
no-typescript:
    @echo "ğŸ” Checking for forbidden TypeScript files..."
    @! find src/ -name "*.ts" -o -name "*.tsx" 2>/dev/null | grep -q . && echo "âœ… No TypeScript files" || (echo "âŒ FORBIDDEN: TypeScript files found in src/" && exit 1)

# MUST: No JavaScript source files in src/ (compiled .mjs is allowed)
no-javascript-source:
    @echo "ğŸ” Checking for forbidden JavaScript source files..."
    @! find src/ -name "*.js" 2>/dev/null | grep -q . && echo "âœ… No JavaScript source files" || (echo "âŒ FORBIDDEN: JavaScript source files found in src/" && exit 1)

# MUST: Only ReScript files in src/
rescript-only:
    @echo "ğŸ” Verifying ReScript-only implementation..."
    @find src/ -type f \( -name "*.py" -o -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.rb" -o -name "*.go" \) 2>/dev/null | grep -q . && (echo "âŒ FORBIDDEN: Non-ReScript files found" && exit 1) || echo "âœ… ReScript-only verified"

# ============================================================================
# Build Requirements
# ============================================================================

# MUST: ReScript compiles without errors
build:
    @echo "ğŸ”¨ Verifying build..."
    @cd adapters && npm run build && echo "âœ… Build successful" || (echo "âŒ Build failed" && exit 1)

# MUST: No compiler warnings treated as errors
build-strict:
    @echo "ğŸ”¨ Verifying strict build..."
    @cd adapters && npm run build 2>&1 | grep -i "error" && (echo "âŒ Build has errors" && exit 1) || echo "âœ… No build errors"

# ============================================================================
# Test Requirements
# ============================================================================

# MUST: All tests pass
test:
    @echo "ğŸ§ª Verifying tests pass..."
    @just test && echo "âœ… All tests pass" || (echo "âŒ Tests failed" && exit 1)

# MUST: E2E tests pass
test-e2e:
    @echo "ğŸ”¬ Verifying E2E tests pass..."
    @just test-e2e && echo "âœ… E2E tests pass" || (echo "âŒ E2E tests failed" && exit 1)

# ============================================================================
# Security Requirements
# ============================================================================

# MUST: No secrets in code
no-secrets:
    @echo "ğŸ”’ Checking for secrets..."
    @! grep -r "password\s*=" src/ adapters/src/ 2>/dev/null | grep -v ".scm" | grep -q . && echo "âœ… No hardcoded passwords" || (echo "âš ï¸  Potential secrets found" && exit 1)
    @! grep -r "api_key\s*=" src/ adapters/src/ 2>/dev/null | grep -v ".scm" | grep -q . && echo "âœ… No hardcoded API keys" || (echo "âš ï¸  Potential secrets found" && exit 1)

# MUST: No vulnerabilities in dependencies
no-vulnerabilities:
    @echo "ğŸ”’ Checking for vulnerabilities..."
    @cd adapters && npm audit --audit-level=high && echo "âœ… No high/critical vulnerabilities" || (echo "âŒ Vulnerabilities found" && exit 1)

# ============================================================================
# Documentation Requirements
# ============================================================================

# MUST: README exists
readme:
    @echo "ğŸ“„ Checking README..."
    @test -f README.adoc && echo "âœ… README.adoc exists" || (echo "âŒ README.adoc missing" && exit 1)

# MUST: LICENSE exists
license:
    @echo "ğŸ“„ Checking LICENSE..."
    @test -f LICENSE.txt && echo "âœ… LICENSE.txt exists" || (echo "âŒ LICENSE.txt missing" && exit 1)

# MUST: SPDX headers in source files
spdx-headers:
    @echo "ğŸ“„ Checking SPDX headers..."
    @grep -l "SPDX-License-Identifier" src/*.res adapters/src/*.res >/dev/null 2>&1 && echo "âœ… SPDX headers present" || (echo "âš ï¸  Some files missing SPDX headers" && exit 1)

# ============================================================================
# SCM Metadata Requirements
# ============================================================================

# MUST: META.scm exists and is valid
meta-scm:
    @echo "ğŸ“‹ Checking META.scm..."
    @test -f META.scm && echo "âœ… META.scm exists" || (echo "âŒ META.scm missing" && exit 1)

# MUST: STATE.scm exists and is valid
state-scm:
    @echo "ğŸ“‹ Checking STATE.scm..."
    @test -f STATE.scm && echo "âœ… STATE.scm exists" || (echo "âŒ STATE.scm missing" && exit 1)

# MUST: ECOSYSTEM.scm exists and is valid
ecosystem-scm:
    @echo "ğŸ“‹ Checking ECOSYSTEM.scm..."
    @test -f ECOSYSTEM.scm && echo "âœ… ECOSYSTEM.scm exists" || (echo "âŒ ECOSYSTEM.scm missing" && exit 1)

# ============================================================================
# Composite Checks
# ============================================================================

# MUST: All language checks pass
language: no-python no-typescript no-javascript-source rescript-only
    @echo "âœ… All language checks passed"

# MUST: All security checks pass
security: no-secrets no-vulnerabilities
    @echo "âœ… All security checks passed"

# MUST: All documentation checks pass
docs: readme license spdx-headers
    @echo "âœ… All documentation checks passed"

# MUST: All SCM checks pass
scm: meta-scm state-scm ecosystem-scm
    @echo "âœ… All SCM checks passed"

# MUST: All checks pass (CI gate)
all: language build test security docs scm
    @echo ""
    @echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    @echo "â•‘     âœ… ALL MUST CHECKS PASSED            â•‘"
    @echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Default: run all checks
default: all
