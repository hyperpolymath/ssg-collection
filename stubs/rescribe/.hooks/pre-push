#!/bin/sh
# SPDX-License-Identifier: AGPL-3.0-or-later
# Pre-push hook for rescribe-ssg
#
# Install: cp .hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -e

echo "üöÄ Running pre-push checks..."

# Language enforcement
echo "  Verifying ReScript-only..."
forbidden=$(find src/ -type f \( -name "*.py" -o -name "*.ts" -o -name "*.tsx" -o -name "*.js" \) 2>/dev/null || true)
if [ -n "$forbidden" ]; then
    echo "‚ùå FORBIDDEN: Non-ReScript files found:"
    echo "$forbidden"
    exit 1
fi

# Full build
echo "  Building..."
cd adapters && npm run build

# SCM file check
echo "  Checking SCM metadata..."
for file in META.scm STATE.scm ECOSYSTEM.scm; do
    if [ ! -f "../$file" ]; then
        echo "‚ùå Missing: $file"
        exit 1
    fi
done

# Security check
echo "  Running security audit..."
npm audit --audit-level=high || echo "  ‚ö†Ô∏è Vulnerabilities found (review recommended)"

echo "‚úÖ Pre-push checks complete"
