# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# RSR-compliant CI workflow with SHA-pinned actions

name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions: read-all

env:
  DENO_VERSION: "1.x"

jobs:
  # ============================================================================
  # LINT & FORMAT CHECK
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check formatting
        run: deno fmt --check adapters/*.js

      - name: Run linter
        run: deno lint adapters/*.js

  # ============================================================================
  # TYPE CHECK
  # ============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Type check adapters
        run: deno check adapters/*.js

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Create test directory if not exists
        run: mkdir -p tests

      - name: Run tests
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests/*.js 2>/dev/null)" ]; then
            deno test --allow-all tests/
          else
            echo "No tests found yet - skipping"
          fi

      - name: Verify adapters load
        run: |
          for adapter in adapters/*.js; do
            echo "Checking $adapter..."
            deno eval "import('file://$PWD/$adapter').then(m => console.log('✓', m.name || 'unnamed'))"
          done

  # ============================================================================
  # SECURITY CHECKS
  # ============================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          if grep -rn "password\s*=\s*['\"]" --include="*.js" adapters/; then
            echo "::error::Potential hardcoded password found"
            exit 1
          fi
          if grep -rn "api.key\s*=\s*['\"]" --include="*.js" adapters/; then
            echo "::error::Potential hardcoded API key found"
            exit 1
          fi
          echo "No secrets detected"

      - name: Check for eval usage
        run: |
          if grep -rn "eval\s*(" --include="*.js" adapters/; then
            echo "::error::eval() usage detected - security risk"
            exit 1
          fi
          echo "No eval() usage detected"

      - name: Check SPDX headers
        run: |
          missing_headers=""
          for file in adapters/*.js; do
            if ! grep -q "SPDX-License-Identifier" "$file"; then
              missing_headers="$missing_headers $file"
            fi
          done
          if [ -n "$missing_headers" ]; then
            echo "::error::Files missing SPDX headers:$missing_headers"
            exit 1
          fi
          echo "All files have SPDX headers"

  # ============================================================================
  # ADAPTER VALIDATION
  # ============================================================================
  validate-adapters:
    name: Validate Adapters
    runs-on: ubuntu-latest
    needs: [lint]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Validate adapter exports
        run: |
          echo "Validating adapter exports..."
          deno eval "
            const adapters = [...Deno.readDirSync('./adapters')]
              .filter(f => f.name.endsWith('.js'))
              .map(f => f.name);

            for (const adapter of adapters) {
              const mod = await import('./adapters/' + adapter);
              const errors = [];

              if (!mod.name) errors.push('missing name export');
              if (!mod.language) errors.push('missing language export');
              if (!mod.tools || !Array.isArray(mod.tools)) errors.push('missing or invalid tools export');
              if (typeof mod.connect !== 'function') errors.push('missing connect function');
              if (typeof mod.disconnect !== 'function') errors.push('missing disconnect function');
              if (typeof mod.isConnected !== 'function') errors.push('missing isConnected function');

              if (errors.length > 0) {
                console.error('✗', adapter, '-', errors.join(', '));
                Deno.exit(1);
              }
              console.log('✓', adapter, '- exports valid');
            }
            console.log('All adapters validated successfully!');
          "

      - name: Count adapters
        run: |
          count=$(ls -1 adapters/*.js | wc -l)
          echo "Total adapters: $count"
          echo "ADAPTER_COUNT=$count" >> $GITHUB_ENV

  # ============================================================================
  # SUMMARY
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, security, validate-adapters]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi
          if [ "${{ needs.typecheck.result }}" != "success" ]; then
            echo "Type check failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Tests failed"
            exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security checks failed"
            exit 1
          fi
          if [ "${{ needs.validate-adapters.result }}" != "success" ]; then
            echo "Adapter validation failed"
            exit 1
          fi
          echo "All CI checks passed! ✓"
