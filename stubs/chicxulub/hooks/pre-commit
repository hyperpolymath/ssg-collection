#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# pre-commit hook for chicxulub--ssg
# Install: cp hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -euo pipefail

# Configuration
HOOKS_CONFIG="${HOOKS_CONFIG:-hooks/config.sh}"
SKIP_HOOKS="${SKIP_HOOKS:-0}"
VERBOSE="${VERBOSE:-0}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() { echo -e "${GREEN}[pre-commit]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[pre-commit]${NC} $1"; }
log_error() { echo -e "${RED}[pre-commit]${NC} $1"; }
log_verbose() { [[ "$VERBOSE" == "1" ]] && echo -e "[pre-commit] $1" || true; }

# Allow skipping hooks
if [[ "$SKIP_HOOKS" == "1" ]]; then
    log_warn "Hooks skipped (SKIP_HOOKS=1)"
    exit 0
fi

# Load custom configuration if exists
if [[ -f "$HOOKS_CONFIG" ]]; then
    log_verbose "Loading config from $HOOKS_CONFIG"
    source "$HOOKS_CONFIG"
fi

# Default configuration
ENABLE_FORMAT_CHECK="${ENABLE_FORMAT_CHECK:-1}"
ENABLE_LINT="${ENABLE_LINT:-1}"
ENABLE_TYPECHECK="${ENABLE_TYPECHECK:-1}"
ENABLE_SECRETS_SCAN="${ENABLE_SECRETS_SCAN:-1}"
ENABLE_SPDX_CHECK="${ENABLE_SPDX_CHECK:-1}"

# Get staged files
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' || true)

if [[ -z "$STAGED_JS_FILES" ]]; then
    log_info "No JavaScript files staged, skipping checks"
    exit 0
fi

log_info "Checking staged files..."

# Format check
if [[ "$ENABLE_FORMAT_CHECK" == "1" ]]; then
    log_info "Checking formatting..."
    if ! deno fmt --check $STAGED_JS_FILES 2>/dev/null; then
        log_error "Formatting issues found. Run 'deno fmt' to fix."
        exit 1
    fi
    log_verbose "Format check passed"
fi

# Lint check
if [[ "$ENABLE_LINT" == "1" ]]; then
    log_info "Running linter..."
    if ! deno lint $STAGED_JS_FILES 2>/dev/null; then
        log_error "Linting errors found. Fix them before committing."
        exit 1
    fi
    log_verbose "Lint check passed"
fi

# Type check
if [[ "$ENABLE_TYPECHECK" == "1" ]]; then
    log_info "Type checking..."
    if ! deno check $STAGED_JS_FILES 2>/dev/null; then
        log_error "Type errors found. Fix them before committing."
        exit 1
    fi
    log_verbose "Type check passed"
fi

# Secrets scan
if [[ "$ENABLE_SECRETS_SCAN" == "1" ]]; then
    log_info "Scanning for secrets..."
    for file in $STAGED_JS_FILES; do
        if grep -qE "(password|secret|api.?key|token)\s*=\s*['\"][^'\"]+['\"]" "$file" 2>/dev/null; then
            log_error "Potential secret found in $file"
            exit 1
        fi
    done
    log_verbose "Secrets scan passed"
fi

# SPDX header check
if [[ "$ENABLE_SPDX_CHECK" == "1" ]]; then
    log_info "Checking SPDX headers..."
    for file in $STAGED_JS_FILES; do
        if ! grep -q "SPDX-License-Identifier" "$file" 2>/dev/null; then
            log_error "Missing SPDX header in $file"
            exit 1
        fi
    done
    log_verbose "SPDX check passed"
fi

log_info "All pre-commit checks passed! âœ“"
exit 0
