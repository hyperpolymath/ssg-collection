# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
#
# CI/CD Pipeline for Division One SSG
# Runs on: push, pull_request, schedule

name: CI

on:
  push:
    branches: ["main"]
    paths:
      - 'adapters/**'
      - 'justfile'
      - 'Mustfile'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: ["main"]
  schedule:
    # Weekly security scan (Sundays at 00:00 UTC)
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read

env:
  DENO_VERSION: "2.1.4"

jobs:
  # ==========================================================================
  # LINT JOB
  # ==========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e0c1f32f4759a0c8e20ecbd7c4cffc64d2 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check formatting
        run: deno fmt --check adapters/

      - name: Run linter
        run: deno lint adapters/

      - name: Validate adapter structure
        run: |
          echo "Validating adapter exports..."
          for f in adapters/*.js; do
            echo "Checking $f..."
            grep -q "export const name" "$f" || { echo "Missing: name"; exit 1; }
            grep -q "export const language" "$f" || { echo "Missing: language"; exit 1; }
            grep -q "export const tools" "$f" || { echo "Missing: tools"; exit 1; }
            grep -q "SPDX-License-Identifier" "$f" || { echo "Missing: SPDX header"; exit 1; }
          done
          echo "All adapters valid!"

  # ==========================================================================
  # TEST JOB
  # ==========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e0c1f32f4759a0c8e20ecbd7c4cffc64d2 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run tests
        run: |
          # Run tests if test files exist
          if ls tests/*.test.js 2>/dev/null || ls adapters/*.test.js 2>/dev/null; then
            deno test --allow-run --allow-read
          else
            echo "No test files found. Skipping tests."
            echo "Test infrastructure pending (see ROADMAP.md Phase 4)"
          fi

      - name: Cache Deno dependencies
        run: deno cache adapters/*.js 2>/dev/null || true

  # ==========================================================================
  # SECURITY JOB
  # ==========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e0c1f32f4759a0c8e20ecbd7c4cffc64d2 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Security lint rules
        run: |
          echo "Checking for security issues..."

          # Check for eval usage
          if grep -rn "eval(" adapters/; then
            echo "ERROR: eval() usage detected!"
            exit 1
          fi

          # Check for Function constructor
          if grep -rn "new Function(" adapters/; then
            echo "ERROR: Function constructor detected!"
            exit 1
          fi

          # Check for shell string interpolation
          if grep -rn 'Deno.run.*{.*cmd.*:.*`' adapters/; then
            echo "WARNING: Potential shell injection pattern"
          fi

          echo "Security checks passed!"

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -rniE "(password|secret|api_key|token|private_key).*=.*['\"][^'\"]+['\"]" adapters/; then
            echo "WARNING: Potential hardcoded secrets found"
            exit 1
          fi
          echo "No secrets detected."

  # ==========================================================================
  # ADAPTER VALIDATION JOB
  # ==========================================================================
  validate-adapters:
    name: Validate Adapters
    runs-on: ubuntu-latest
    needs: [lint, security]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e0c1f32f4759a0c8e20ecbd7c4cffc64d2 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Count adapters
        run: |
          ADAPTER_COUNT=$(ls -1 adapters/*.js | wc -l)
          echo "Found $ADAPTER_COUNT adapters"

          if [ "$ADAPTER_COUNT" -lt 28 ]; then
            echo "WARNING: Expected 28 adapters, found $ADAPTER_COUNT"
          fi

      - name: Validate Deno.Command usage
        run: |
          echo "Verifying secure command execution..."

          for f in adapters/*.js; do
            # Check that Deno.Command is used (not Deno.run)
            if grep -q "Deno.run" "$f"; then
              echo "ERROR: $f uses deprecated Deno.run. Use Deno.Command instead."
              exit 1
            fi

            # Verify array-based args pattern
            if grep -q "Deno.Command" "$f"; then
              if ! grep -q "args.*\[" "$f"; then
                echo "WARNING: $f may not use array-based args"
              fi
            fi
          done

          echo "Command execution patterns validated!"

      - name: Generate adapter report
        run: |
          echo "# Adapter Report" > adapter-report.md
          echo "" >> adapter-report.md
          echo "Generated: $(date -u)" >> adapter-report.md
          echo "" >> adapter-report.md
          echo "| Adapter | Lines |" >> adapter-report.md
          echo "|---------|-------|" >> adapter-report.md

          for f in adapters/*.js; do
            name=$(basename "$f" .js)
            lines=$(wc -l < "$f")
            echo "| $name | $lines |" >> adapter-report.md
          done

          echo "" >> adapter-report.md
          echo "Total adapters: $(ls -1 adapters/*.js | wc -l)" >> adapter-report.md
          echo "Total lines: $(wc -l adapters/*.js | tail -1 | awk '{print $1}')" >> adapter-report.md

          cat adapter-report.md

      - name: Upload adapter report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: adapter-report
          path: adapter-report.md
          retention-days: 30

  # ==========================================================================
  # CI STATUS JOB
  # ==========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, security, validate-adapters]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi

          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security scan failed"
            exit 1
          fi

          if [ "${{ needs.validate-adapters.result }}" != "success" ]; then
            echo "Adapter validation failed"
            exit 1
          fi

          echo "All CI checks passed!"
