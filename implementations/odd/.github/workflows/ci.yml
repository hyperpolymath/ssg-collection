# SPDX-License-Identifier: PMPL-1.0-or-later
# RSR-compliant CI/CD workflow with SHA-pinned actions

name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: v2.x

      - name: Check formatting
        run: deno fmt --check

      - name: Lint
        run: deno lint

      - name: Type check
        run: deno check **/*.ts

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: v2.x

      - name: Run unit tests
        run: deno test --allow-read --allow-write tests/unit/

      - name: Run E2E tests
        run: deno test --allow-read --allow-write --allow-run tests/e2e/

      - name: Run tests with coverage
        run: |
          deno test --allow-read --allow-write --coverage=coverage/ tests/
          deno coverage coverage/ --lcov > coverage.lcov

      - name: Upload coverage
        uses: codecov/codecov-action@1e68e06f1dbfde0e4cefc87efeba9e4643565f39 # v5.1.2
        with:
          files: coverage.lcov
          fail_ci_if_error: false

  adapter-check:
    name: Adapter Validation
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: v2.x

      - name: Check adapter syntax
        run: |
          for f in adapters/*.js; do
            echo "Checking $f..."
            deno check "$f" || exit 1
          done

      - name: Verify adapter exports
        run: |
          deno eval "
            const adapters = ['zola', 'hakyll', 'serum'];
            for (const name of adapters) {
              const mod = await import('./adapters/' + name + '.js');
              if (!mod.name || !mod.language || !mod.tools) {
                throw new Error(name + ' missing required exports');
              }
              console.log('âœ“', name);
            }
          "

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, adapter-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: v2.x

      - name: Cache dependencies
        run: deno cache mod.ts

      - name: Verify build
        run: |
          echo "Build verification complete"
          deno eval "
            import { VERSION, ADAPTERS } from './mod.ts';
            console.log('Version:', VERSION);
            console.log('Adapters:', ADAPTERS.length);
          "

  container:
    name: Container Build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Build container image
        run: |
          podman build -t odd-ssg:${{ github.sha }} .
          podman tag odd-ssg:${{ github.sha }} odd-ssg:latest

      - name: Test container
        run: |
          podman run --rm odd-ssg:latest deno eval "console.log('Container OK')"
