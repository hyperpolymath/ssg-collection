#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# Pre-push hook for qed-ssg

set -euo pipefail

echo "Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if just is available
if command -v just &> /dev/null; then
    just pre-push
    exit $?
fi

# Fallback to direct commands
echo -e "${YELLOW}Just not found, running checks directly...${NC}"

# 1. Run all tests
echo "Running full test suite..."
if command -v deno &> /dev/null; then
    if ! deno test --allow-read --allow-run adapters/; then
        echo -e "${RED}Tests failed. Push aborted.${NC}"
        exit 1
    fi
    echo -e "${GREEN}✓ All tests passed${NC}"
fi

# 2. Security audit
echo "Running security audit..."

# Check for eval()
if grep -rn 'eval(' adapters/; then
    echo -e "${RED}ERROR: eval() usage detected!${NC}"
    exit 1
fi

# Check for unsafe shell execution
if grep -rn '\$(' adapters/ | grep -v 'Deno.Command' | grep -v '#'; then
    echo -e "${RED}ERROR: Unsafe shell execution detected!${NC}"
    exit 1
fi

# Check for console.log in production code (not tests)
if grep -rn 'console.log' adapters/*.js | grep -v '//'; then
    echo -e "${YELLOW}WARNING: console.log found in adapter code${NC}"
fi

echo -e "${GREEN}✓ Security audit passed${NC}"

# 3. Verify all adapters export required fields
echo "Verifying adapter exports..."
if command -v deno &> /dev/null; then
    for f in adapters/*.js; do
        if [ -f "$f" ]; then
            if ! deno eval "
                import * as a from './$f';
                if (!a.name) throw new Error('Missing name');
                if (!a.language) throw new Error('Missing language');
                if (!a.tools) throw new Error('Missing tools');
            " 2>/dev/null; then
                echo -e "${RED}Invalid adapter: $f${NC}"
                exit 1
            fi
        fi
    done
    echo -e "${GREEN}✓ All adapters valid${NC}"
fi

echo -e "${GREEN}All pre-push checks passed!${NC}"
exit 0
