# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# RSR-compliant test workflow with SHA-pinned actions (ReScript + Deno)

name: "Test"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions: read-all

jobs:
  # Language policy enforcement - runs first
  language-policy:
    name: Language Policy
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for banned TypeScript files
        run: |
          echo "Checking for TypeScript files..."
          if find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "❌ TypeScript files found! This violates the language policy."
            find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.git/*"
            exit 1
          fi
          echo "✅ No TypeScript files found"

      - name: Check for banned TSX files
        run: |
          echo "Checking for TSX files..."
          if find . -name "*.tsx" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "❌ TSX files found!"
            exit 1
          fi
          echo "✅ No TSX files found"

      - name: Check for Makefile
        run: |
          echo "Checking for Makefile..."
          if find . -name "Makefile" -not -path "./.git/*" | grep -q .; then
            echo "❌ Makefile found! Use Justfile instead."
            exit 1
          fi
          echo "✅ No Makefile found"

      - name: Verify ReScript sources exist
        run: |
          echo "Checking for ReScript files..."
          if ! find src -name "*.res" 2>/dev/null | grep -q .; then
            echo "⚠️ No ReScript files in src/"
          else
            echo "✅ ReScript sources found"
            find src -name "*.res" | wc -l
          fi

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: language-policy
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        deno-version: ["v2.x"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js (for ReScript)
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ matrix.deno-version }}

      - name: Verify installations
        run: |
          deno --version
          node --version
          npm --version

      - name: Cache dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/deno
            ~/.deno
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/deno.json', '**/rescript.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install ReScript
        run: npm install rescript@11

      - name: Build ReScript
        run: npx rescript build

      - name: Check JS formatting
        run: deno fmt --check runtime/*.js *.js || true

      - name: Run linter
        run: deno lint runtime/*.js *.js || true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js (for ReScript)
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: "v2.x"

      - name: Install ReScript
        run: npm install rescript@11

      - name: Build ReScript
        run: npx rescript build

      - name: Run tests
        run: deno test --allow-all lib/es6/test/ || echo "Tests pending"

  lint-security:
    name: Security Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          ! grep -rE "(password|secret|api.key)\s*[:=]\s*['\"]" --include="*.js" --include="*.res" src/ runtime/ adapters/ 2>/dev/null || \
            (echo "WARNING: Potential secrets found" && exit 1)
          echo "✅ No hardcoded secrets found"

      - name: Check for eval usage
        run: |
          echo "Scanning for eval usage..."
          ! grep -rE "eval\(|Function\(" --include="*.js" --include="*.res" src/ runtime/ 2>/dev/null || \
            (echo "WARNING: eval or Function constructor found" && exit 1)
          echo "✅ No eval usage found"

      - name: Verify SPDX headers in ReScript
        run: |
          echo "Checking SPDX headers in ReScript files..."
          for file in src/*.res src/**/*.res; do
            if [ -f "$file" ]; then
              if ! head -2 "$file" | grep -q "SPDX-License-Identifier"; then
                echo "Missing SPDX header in $file"
                exit 1
              fi
            fi
          done
          echo "✅ All ReScript files have SPDX headers"

      - name: Verify SPDX headers in JS glue
        run: |
          echo "Checking SPDX headers in JS glue..."
          for file in runtime/*.js; do
            if [ -f "$file" ]; then
              if ! head -2 "$file" | grep -q "SPDX-License-Identifier"; then
                echo "Missing SPDX header in $file"
                exit 1
              fi
            fi
          done
          echo "✅ All JS glue files have SPDX headers"

  adapter-validation:
    name: Adapter Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: "v2.x"

      - name: Validate adapter exports
        run: |
          if [ -d adapters ] && ls adapters/*.js 1>/dev/null 2>&1; then
            for adapter in adapters/*.js; do
              name=$(basename "$adapter" .js)
              echo "Validating $name adapter..."
              deno eval "
                const a = await import('./$adapter');
                if (!a.name) throw new Error('Missing name export');
                if (!a.language) throw new Error('Missing language export');
                if (!a.description) throw new Error('Missing description export');
                if (!a.tools || !Array.isArray(a.tools)) throw new Error('Missing tools export');
                if (a.tools.length < 5) throw new Error('Need at least 5 tools');
                if (typeof a.connect !== 'function') throw new Error('Missing connect function');
                if (typeof a.disconnect !== 'function') throw new Error('Missing disconnect function');
                if (typeof a.isConnected !== 'function') throw new Error('Missing isConnected function');
                console.log('✓ $name adapter is valid');
              "
            done
            echo "All adapters validated successfully!"
          else
            echo "No adapters directory or no JS files - skipping validation"
          fi

      - name: Count adapters
        run: |
          if [ -d adapters ] && ls adapters/*.js 1>/dev/null 2>&1; then
            count=$(ls -1 adapters/*.js | wc -l)
            echo "Total adapters: $count"
            if [ "$count" -lt 28 ]; then
              echo "INFO: Expected 28 adapters, found $count"
            fi
          else
            echo "No adapters yet"
          fi
